로지텍 K380 키보드를 사용 중인데, 멀티 페어링을 지원하는 키보드인데도 듀얼OS 환경에서 각 프로파일에 따로 연결이 안됨. 무조건 다른 OS로 넘어갈 때 마다 새로 페어링을 해 주어야 하는 아주 귀찮은 문제 발생.

[해결법 링크](https://hallymer.github.io/etc/2021/02/23/Multiboot-bluetooth-keyboard-connecting-post.html)

맨 처음엔 우분투에서 chntpw 프로그램을 이용해 레지스트리 값을 읽어오는 방식을 시도했지만, BLE가 아닌 BR/EDR 제품군은 키값을 읽지 못함. 위 링크처럼 윈도우 psexec.exe 프로그램을 이용해 키값을 받아옴.

시작하기 전에 앞서 우분투에 블루투스 기기를 먼저 페어링한 후 그 다음에 윈도우에서 페어링을 다시 하고 하단의 조치를 취하면 된다.
### 1. PSEXEC.EXE 설치

[PSTools 링크](https://learn.microsoft.com/ko-kr/sysinternals/downloads/psexec)
위 링크에서 pstools를 다운로드 한 후 'psexec.exe' 만 압축을 해제해 줌.

### 2. 윈도우에서 키값 받아오기

윈도우에서 powershell을 관리자 권한으로 실행 후, psexec.exe 파일을 압축해제한 경로까지 이동.

`.\psexec.exe -s -i regedit /e C:\BTKeys.reg HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\BTHPORT\Parameters\Keys`

위의 명령어를 이용해 C드라이브에 블루투스 키값에 대한 레지스트리를 따 온다.
경로 중 'ControlSet001' 의 숫자가 001이 아닌 다른 숫자일 수도 있다고 하는데, 직접 확인하는 수밖에 없을 것 같다.
"regedit exited with error code 0" 라는 에러 코드가 뜨는데, 리턴값(0)을 받았다는 뜻으로 에러가 아닌 정상 작동을 했다는 뜻이다.

C 드라이브에 가 보면
```shell title:"BTKeys.reg"
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\BTHPORT\Parameters\Keys]

[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\BTHPORT\Parameters\Keys\c03532490bd8]
"CentralIRK"=hex:2d,81,15,85,3f,46,fd,1c,b7,7b,b7,9b,7f,c6,bb,78
"646d2fa6f0a2"=hex:14,2c,ea,41,f1,b1,96,4b,1f,af,d7,fb,ff,c0,20,7f
"f47335531d7b"=hex:55,e3,12,bd,bc,40,30,de,63,c0,aa,9f,3a,f6,2c,dc

[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\BTHPORT\Parameters\Keys\c03532490bd8\599ddd55480c]
"LTK"=hex:41,ec,d0,a0,cf,2c,09,85,b3,c3,a9,48,dc,5c,21,35
"KeyLength"=dword:00000010
"ERand"=hex(b):00,00,00,00,00,00,00,00
"EDIV"=dword:00000000
"IRK"=hex:3e,0c,5b,63,3e,b5,0b,91,48,ce,bf,e0,4e,86,cd,dc
"Address"=hex(b):a2,f0,a6,2f,6d,64,00,00
"AddressType"=dword:00000000
"CEntralIRKStatus"=dword:00000001
"AuthReq"=dword:0000002d
```
이런 레지스트리 파일이 생성된 것을 확인할 수 있다.

`.\psexec.exe -s -i regedit` 명령어를 사용해 레지스트리 편집기를 실행한 후
`HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\BTHPORT\Parameters\Keys`
위의 경로로 가면,

![[../Images/KakaoTalk_20250814_235608002.jpg]]
이런 화면이 뜨는데, 이 화면에서도 필요한 정보를 모두 얻을 수 있다.
빨간색 부분이 내 PC의 블루투스 MAC 주소이고, 녹색 부분이 내 주변기기(K380 키보드)의 MAC 주소이다.
파란색 밑줄 부분은 내 해당 주변기기의 연결 키 값이다.

### 3. 우분투에서 블루투스 INFO 수정

위의 키값들을 모두 저장했으면 우분투로 넘어온다.
`/var/lib/bluetooth` 경로로 가면 내 PC의 블루투스 맥 주소가 나오는데, 그 폴더까지 들어간다.
그 하위 폴더에는 여러 폴더들이 있을 수 있는데, 그 중 윈도우에서 찾은 내 주변기기의 주소와 이름이 거의 동일하거나 아예 같은 폴더에 들어간다.
인터넷에 다른 사람들은 모두 맥 주소 중 뒷 자리 1~2개만 제외하고 전부 동일하게 뜨는 패턴이 있었는데, 나는 아예 동일하게 떴다.

폴더에 들어가면 info라는 파일이 있는데, 텍스트 편집기로 열어주면
![[../Images/Pasted image 20250815000501.png]]
이렇게 창이 뜬다.
맥 주소를 보고 내가 설정하려고 하는 주변기기인지 아닌지 모른다면, 아무 폴더나 들어가서 info 파일을 열어보면 위의 사진처럼 기기의 이름이 뜨기 때문에 이 이름을 보고 특정하면 된다.

만약 나처럼 맥 주소는 동일하게 뜬다면, LinkKey 하위의 Key값을 위에서 얻은 키값으로 바꿔주면 된다.
레지스트리 편집기 캡쳐 사진 기준 파란색 밑줄 부분, BTKeys.reg 파일 기준`"주변기기 맥 주소"=hex:키값`
이런 패턴으로 있는 키값을 찾아서